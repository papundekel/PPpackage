name: Test

on:
    push:
        branches-ignore:
            - main

jobs:
    build-metamanager:
        runs-on: ubuntu-latest
        steps:
            - uses: docker/setup-buildx-action@v3.0.0

            - uses: docker/build-push-action@v5.3.0
              with:
                  target: metamanager
                  tags: docker.io/fackop/pppackage-metamanager:latest
                  outputs: type=docker,dest=/tmp/image-metamanager.tar
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - uses: actions/upload-artifact@v4.3.3
              with:
                  name: image-metamanager
                  path: /tmp/image-metamanager.tar
    build-solver:
        runs-on: ubuntu-latest
        steps:
            - uses: docker/setup-buildx-action@v3.0.0

            - uses: docker/build-push-action@v5.3.0
              with:
                  target: solver
                  tags: docker.io/fackop/pppackage-solver:latest
                  outputs: type=docker,dest=/tmp/image-solver.tar
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - uses: actions/upload-artifact@v4.3.3
              with:
                  name: image-solver
                  path: /tmp/image-solver.tar
    build-updater:
        runs-on: ubuntu-latest
        steps:
            - uses: docker/setup-buildx-action@v3.0.0

            - uses: docker/build-push-action@v5.3.0
              with:
                  target: updater
                  tags: docker.io/fackop/pppackage-updater:latest
                  outputs: type=docker,dest=/tmp/image-updater.tar
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - uses: actions/upload-artifact@v4.3.3
              with:
                  name: image-updater
                  path: /tmp/image-updater.tar
    build-repo-pacman:
        runs-on: ubuntu-latest
        steps:
            - uses: docker/setup-buildx-action@v3.0.0

            - uses: docker/build-push-action@v5.3.0
              with:
                  target: repository-driver-pacman
                  tags: docker.io/fackop/pppackage-repository-driver-pacman:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
    build-repo-aur:
        runs-on: ubuntu-latest
        steps:
            - uses: docker/setup-buildx-action@v3.0.0

            - uses: docker/build-push-action@v5.3.0
              with:
                  target: repository-driver-aur
                  tags: docker.io/fackop/pppackage-repository-driver-aur:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
    build-repo-conan:
        runs-on: ubuntu-latest
        steps:
            - uses: docker/setup-buildx-action@v3.0.0

            - uses: docker/build-push-action@v5.3.0
              with:
                  target: repository-driver-conan
                  tags: docker.io/fackop/pppackage-repository-driver-conan:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
    build-repo-pp:
        runs-on: ubuntu-latest
        steps:
            - uses: docker/setup-buildx-action@v3.0.0

            - uses: docker/build-push-action@v5.3.0
              with:
                  target: repository-driver-pp
                  tags: docker.io/fackop/pppackage-repository-driver-pp:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
    test:
        runs-on: ubuntu-latest
        needs:
            - build-metamanager
            - build-updater
            - build-solver
        steps:
            - uses: actions/checkout@v4.1.1

            - name: Install podman
              uses: awalsh128/cache-apt-pkgs-action@v1.4.2
              with:
                  packages: podman

            - name: Download seccomp.json
              run: sudo wget https://raw.githubusercontent.com/containers/common/main/pkg/seccomp/seccomp.json --output-document /etc/containers/seccomp.json

            - name: Cache caches
              uses: actions/cache@v4.0.2
              with:
                  path: ${{ github.workspace }}/cache/
                  key: cache

            - name: Cache databases
              uses: actions/cache@v4.0.2
              with:
                  path: ${{ github.workspace }}/database/
                  key: database

            - name: Download image artifacts
              uses: actions/download-artifact@v4.1.7
              with:
                  pattern: image-*
                  path: /tmp/
                  merge-multiple: true

            - name: Load images
              run: |
                  docker load --input /tmp/image-metamanager.tar
                  docker load --input /tmp/image-updater.tar
                  podman load --input /tmp/image-solver.tar
                  podman tag localhost/latest:latest docker.io/fackop/pppackage-solver:latest

            - name: Create directories
              run: |
                  mkdir -p root/ output/ cache/ workdir/
                  mkdir -p database/archlinux-core/ database/archlinux-extra/ database/AUR/ database/conancenter/

            - name: Update archlinux core database
              run: >
                  docker run --rm
                  --user $(id -u):$(id -g)
                  --mount type=bind,source=${{ github.workspace }}/database/archlinux-core/,target=/mnt/database/
                  --mount type=bind,source=${{ github.workspace }}/examples/update/repository-pacman.json,target=/mnt/repository.json
                  --env REPOSITORY=core
                  --env DATABASE_PATH=/mnt/database/
                  docker.io/fackop/pppackage-updater:latest
                  PPpackage.repository_driver.pacman
                  --repository /mnt/repository.json

            - name: Update archlinux extra database
              run: >
                  docker run --rm
                  --user $(id -u):$(id -g)
                  --mount type=bind,source=${{ github.workspace }}/database/archlinux-extra/,target=/mnt/database/
                  --mount type=bind,source=${{ github.workspace }}/examples/update/repository-pacman.json,target=/mnt/repository.json
                  --env REPOSITORY=extra
                  --env DATABASE_PATH=/mnt/database/
                  docker.io/fackop/pppackage-updater:latest
                  PPpackage.repository_driver.pacman
                  --repository /mnt/repository.json

            - name: Update AUR database
              run: >
                  docker run --rm
                  --user $(id -u):$(id -g)
                  --mount type=bind,source=${{ github.workspace }}/database/AUR/,target=/mnt/database/
                  --mount type=bind,source=${{ github.workspace }}/examples/update/repository-AUR.json,target=/mnt/repository.json
                  --env DATABASE_PATH=/mnt/database/
                  docker.io/fackop/pppackage-updater:latest
                  PPpackage.repository_driver.AUR
                  --repository /mnt/repository.json

            - name: Check if conancenter database exists
              id: check_conancenter
              uses: andstor/file-existence-action@v3.0.0
              with:
                  files: database/conancenter/cache/

            - name: Update conancenter database
              if: steps.check_conancenter.outputs.files_exists == 'false'
              run: >
                  docker run --rm
                  --user $(id -u):$(id -g)
                  --mount type=bind,source=${{ github.workspace }}/database/conancenter/,target=/mnt/database/
                  --mount type=bind,source=${{ github.workspace }}/examples/update/repository-conancenter.json,target=/mnt/repository.json
                  --env DATABASE_PATH=/mnt/database/
                  docker.io/fackop/pppackage-updater:latest
                  PPpackage.repository_driver.conan
                  --repository /mnt/repository.json

            - name: Create default conan profile
              if: steps.check_conancenter.outputs.files_exists == 'false'
              run: >
                  docker run --rm
                  --user $(id -u):$(id -g)
                  --mount type=bind,source=${{ github.workspace }}/database/conancenter/,target=/mnt/database/
                  --env CONAN_HOME=/mnt/database/cache/
                  --entrypoint conan
                  docker.io/fackop/pppackage-updater:latest
                  profile detect

            - name: Run PPpackage
              run: >
                  USER="$(id -u):$(id -g)" docker compose
                  --file .github/compose.yaml
                  run --rm
                  -T metamanager < examples/input/basic-pacman.json

            - name: Test alpm hooks (check if ldconfig ran)
              run: ls -l root/etc/ld.so.cache
